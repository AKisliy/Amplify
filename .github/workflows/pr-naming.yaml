name: "Auto-format PR Title & Body"

on:
    pull_request:
        types: [opened]

permissions:
    pull-requests: write

jobs:
    update-pr:
        runs-on: ubuntu-latest
        steps:
            - name: Update PR Details
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  BRANCH_NAME: ${{ github.head_ref }}
                  PR_NUMBER: ${{ github.event.pull_request.number }}
              run: |
                  echo "Processing branch: $BRANCH_NAME"

                  # 1. Убираем префикс (feature/, bugfix/, hotfix/)
                  # feature/AMPLIFY-87-Base-CI-CD-for-Publisher -> AMPLIFY-87-Base-CI-CD-for-Publisher
                  CLEAN_NAME=$(echo "$BRANCH_NAME" | sed -E 's/^(feature|bugfix|hotfix)\///')

                  # 2. Ищем тикет (AMPLIFY-87)
                  # Регулярка ищет БУКВЫ-ЦИФРЫ в начале строки
                  TICKET_ID=$(echo "$CLEAN_NAME" | grep -oE '^[A-Z]+-[0-9]+')

                  # Если тикет не найден, выходим, чтобы не ломать PR
                  if [[ -z "$TICKET_ID" ]]; then
                    echo "No ticket ID found in branch name. Skipping."
                    exit 0
                  fi

                  # 3. Вытаскиваем номер задачи для Closes # (87 из AMPLIFY-87)
                  ISSUE_NUMBER=$(echo "$TICKET_ID" | cut -d'-' -f2)

                  # 4. Формируем текст заголовка
                  # Убираем тикет из начала строки и заменяем дефисы на пробелы
                  # AMPLIFY-87-Base-CI-CD-for-Publisher -> Base-CI-CD-for-Publisher -> Base CI CD for Publisher
                  DESCRIPTION=$(echo "$CLEAN_NAME" | sed "s/^$TICKET_ID-//" | sed 's/-/ /g')

                  # 5. Собираем итоговые строки
                  NEW_TITLE="$TICKET_ID: $DESCRIPTION"
                  NEW_BODY="Closes #$ISSUE_NUMBER"

                  echo "New Title: $NEW_TITLE"
                  echo "New Body: $NEW_BODY"

                  # 6. Обновляем PR через GitHub CLI
                  # Если в описании уже что-то было, этот скрипт его ПЕРЕЗАТРЕТ.
                  # Если хочешь дописывать, нужно сначала прочитать текущее body через gh pr view
                  gh pr edit "$PR_NUMBER" --title "$NEW_TITLE" --body "$NEW_BODY"
