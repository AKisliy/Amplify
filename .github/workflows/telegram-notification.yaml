name: Notify Telegram on PR to Main

on:
  pull_request:
    types: [opened, closed]
    branches: [main]

jobs:
  notify-opened:
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'opened'}}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Filter changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend: 'frontend/**'
            userservice: 'userservice/**'
            publisher: 'publisher/**'
            media-ingest: 'media-ingest/**'
            template-service: 'template-service/**'

      - name: Build Notification Message
        run: |
          SERVICES=""

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥–∏ –∏ —Å–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫
          [[ "${{ steps.filter.outputs.userservice }}" == "true" ]] && SERVICES+="- üì¶ userservice"$'\n'
          [[ "${{ steps.filter.outputs.publisher }}" == "true" ]] && SERVICES+="- üì¶ publisher"$'\n'
          [[ "${{ steps.filter.outputs.media-ingest }}" == "true" ]] && SERVICES+="- üì¶ media-ingest"$'\n'
          [[ "${{ steps.filter.outputs.frontend }}" == "true" ]] && SERVICES+="- üì¶ frontend"$'\n'
          [[ "${{ steps.filter.outputs.template-service }}" == "true" ]] && SERVICES+="- üì¶ template-service"$'\n'

          # –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–∞ –ø–∞–ø–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–º–µ–Ω—è–ª–∏ —Ç–æ–ª—å–∫–æ README)
          [[ -z "$SERVICES" ]] && SERVICES="- ‚öôÔ∏è –¢–æ–ª—å–∫–æ –æ–±—â–∏–µ —Ñ–∞–π–ª—ã/–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞"

          {
            echo "TG_MESSAGE<<EOF"
            echo "üî• *–ù–æ–≤—ã–π Pull Request –≤ main!*"
            echo "üë§ *–ê–≤—Ç–æ—Ä:* ${{ github.actor }}"
            echo ""
            echo "üõ† *–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Å–µ—Ä–≤–∏—Å—ã:*"
            echo "$SERVICES"
            echo "üîó [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å PR #${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }})"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Send Telegram Notification to Topic
        uses: ./.github/actions/telegram-notify
        with:
          message: ${{ env.TG_MESSAGE }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          topic_id: ${{ vars.TELEGRAM_TOPIC_ID }}
          bot_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}

  notify-merged:
    if: github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Build Notification Message
        run: |
          {
            echo "TG_MESSAGE<<EOF"
            echo "‚úÖ [PR #${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }}) *–±—ã–ª —É—Å–ø–µ—à–Ω–æ —Å–º–µ—Ä–∂–µ–Ω –≤ main!*"
            echo "üó£Ô∏è –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä: ${{ github.actor }}"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Send Telegram Notification to Topic
        uses: ./.github/actions/telegram-notify
        with:
          message: ${{ env.TG_MESSAGE }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          topic_id: ${{ vars.TELEGRAM_TOPIC_ID }}
          bot_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
