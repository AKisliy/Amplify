---
# Source: infra/templates/secret-store.yaml
apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: gcp-store
spec:
  provider:
    gcpsm:
      projectID: proven-aviary-484307-c9
      auth:
        workloadIdentity:
          clusterLocation: europe-west3-a
          clusterName: amplify-cluster
          serviceAccountRef:
            name: external-secrets
            namespace: external-secrets
---
# Source: infra/templates/amplify-gateway.yaml
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: amplify-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - hosts:
    - amplify.34.40.73.43.nip.io
    port:
      name: http
      number: 80
      protocol: HTTP

---
# Source: postgresql/templates/primary/networkpolicy.yaml
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: postgres-postgresql
  namespace: "test-env"
  labels:
    app.kubernetes.io/instance: postgres
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/version: 16.2.0
    helm.sh/chart: postgresql-15.0.0
    app.kubernetes.io/component: primary
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/instance: postgres
      app.kubernetes.io/name: postgresql
      app.kubernetes.io/component: primary
  policyTypes:
    - Ingress
    - Egress
  egress:
    - {}
  ingress:
    - ports:
        - port: 5432
---
# Source: postgresql/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: postgres-postgresql
  namespace: "test-env"
  labels:
    app.kubernetes.io/instance: postgres
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/version: 16.2.0
    helm.sh/chart: postgresql-15.0.0
automountServiceAccountToken: false
---
# Source: postgresql/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: postgres-postgresql
  namespace: "test-env"
  labels:
    app.kubernetes.io/instance: postgres
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/version: 16.2.0
    helm.sh/chart: postgresql-15.0.0
type: Opaque
data:
  postgres-password: "c3VwZXJTZWNyZXRQYXNzd29yZDEyMw=="
  password: "YXBwX3Bhc3N3b3Jk"
  # We don't auto-generate LDAP password when it's not provided as we do for other passwords
---
# Source: postgresql/templates/primary/svc-headless.yaml
apiVersion: v1
kind: Service
metadata:
  name: postgres-postgresql-hl
  namespace: "test-env"
  labels:
    app.kubernetes.io/instance: postgres
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/version: 16.2.0
    helm.sh/chart: postgresql-15.0.0
    app.kubernetes.io/component: primary
  annotations:
    # Use this annotation in addition to the actual publishNotReadyAddresses
    # field below because the annotation will stop being respected soon but the
    # field is broken in some versions of Kubernetes:
    # https://github.com/kubernetes/kubernetes/issues/58662
    service.alpha.kubernetes.io/tolerate-unready-endpoints: "true"
spec:
  type: ClusterIP
  clusterIP: None
  # We want all pods in the StatefulSet to have their addresses published for
  # the sake of the other Postgresql pods even before they're ready, since they
  # have to be able to talk to each other in order to become ready.
  publishNotReadyAddresses: true
  ports:
    - name: tcp-postgresql
      port: 5432
      targetPort: tcp-postgresql
  selector:
    app.kubernetes.io/instance: postgres
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/component: primary
---
# Source: postgresql/templates/primary/svc.yaml
apiVersion: v1
kind: Service
metadata:
  name: postgres-postgresql
  namespace: "test-env"
  labels:
    app.kubernetes.io/instance: postgres
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/version: 16.2.0
    helm.sh/chart: postgresql-15.0.0
    app.kubernetes.io/component: primary
spec:
  type: ClusterIP
  sessionAffinity: None
  ports:
    - name: tcp-postgresql
      port: 5432
      targetPort: tcp-postgresql
      nodePort: null
  selector:
    app.kubernetes.io/instance: postgres
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/component: primary
---
# Source: postgresql/templates/primary/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres-postgresql
  namespace: "test-env"
  labels:
    app.kubernetes.io/instance: postgres
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/version: 16.2.0
    helm.sh/chart: postgresql-15.0.0
    app.kubernetes.io/component: primary
spec:
  replicas: 1
  serviceName: postgres-postgresql-hl
  updateStrategy:
    rollingUpdate: {}
    type: RollingUpdate
  selector:
    matchLabels:
      app.kubernetes.io/instance: postgres
      app.kubernetes.io/name: postgresql
      app.kubernetes.io/component: primary
  template:
    metadata:
      name: postgres-postgresql
      labels:
        app.kubernetes.io/instance: postgres
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: postgresql
        app.kubernetes.io/version: 16.2.0
        helm.sh/chart: postgresql-15.0.0
        app.kubernetes.io/component: primary
    spec:
      serviceAccountName: postgres-postgresql
      
      automountServiceAccountToken: false
      affinity:
        podAffinity:
          
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/instance: postgres
                    app.kubernetes.io/name: postgresql
                    app.kubernetes.io/component: primary
                topologyKey: kubernetes.io/hostname
              weight: 1
        nodeAffinity:
          
      securityContext:
        fsGroup: 1001
        fsGroupChangePolicy: Always
        supplementalGroups: []
        sysctls: []
      hostNetwork: false
      hostIPC: false
      containers:
        - name: postgresql
          image: docker.io/bitnami/postgresql:latest
          imagePullPolicy: "IfNotPresent"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            privileged: false
            readOnlyRootFilesystem: true
            runAsGroup: 1001
            runAsNonRoot: true
            runAsUser: 1001
            seLinuxOptions: {}
            seccompProfile:
              type: RuntimeDefault
          env:
            - name: BITNAMI_DEBUG
              value: "false"
            - name: POSTGRESQL_PORT_NUMBER
              value: "5432"
            - name: POSTGRESQL_VOLUME_DIR
              value: "/bitnami/postgresql"
            - name: PGDATA
              value: "/bitnami/postgresql/data"
            # Authentication
            - name: POSTGRES_USER
              value: "app_user"
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-postgresql
                  key: password
            - name: POSTGRES_POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-postgresql
                  key: postgres-password
            - name: POSTGRES_DATABASE
              value: "amplify_db"
            # Replication
            # Initdb
            # Standby
            # LDAP
            - name: POSTGRESQL_ENABLE_LDAP
              value: "no"
            # TLS
            - name: POSTGRESQL_ENABLE_TLS
              value: "no"
            # Audit
            - name: POSTGRESQL_LOG_HOSTNAME
              value: "false"
            - name: POSTGRESQL_LOG_CONNECTIONS
              value: "false"
            - name: POSTGRESQL_LOG_DISCONNECTIONS
              value: "false"
            - name: POSTGRESQL_PGAUDIT_LOG_CATALOG
              value: "off"
            # Others
            - name: POSTGRESQL_CLIENT_MIN_MESSAGES
              value: "error"
            - name: POSTGRESQL_SHARED_PRELOAD_LIBRARIES
              value: "pgaudit"
          ports:
            - name: tcp-postgresql
              containerPort: 5432
          livenessProbe:
            failureThreshold: 6
            initialDelaySeconds: 30
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
            exec:
              command:
                - /bin/sh
                - -c
                - exec pg_isready -U "app_user" -d "dbname=amplify_db" -h 127.0.0.1 -p 5432
          readinessProbe:
            failureThreshold: 6
            initialDelaySeconds: 5
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
            exec:
              command:
                - /bin/sh
                - -c
                - -e
                - |
                  exec pg_isready -U "app_user" -d "dbname=amplify_db" -h 127.0.0.1 -p 5432
                  [ -f /opt/bitnami/postgresql/tmp/.initialized ] || [ -f /bitnami/postgresql/.initialized ]
          resources:
            limits:
              cpu: 150m
              ephemeral-storage: 1024Mi
              memory: 192Mi
            requests:
              cpu: 100m
              ephemeral-storage: 50Mi
              memory: 128Mi
          volumeMounts:
            - name: empty-dir
              mountPath: /tmp
              subPath: tmp-dir
            - name: empty-dir
              mountPath: /opt/bitnami/postgresql/conf
              subPath: app-conf-dir
            - name: empty-dir
              mountPath: /opt/bitnami/postgresql/tmp
              subPath: app-tmp-dir
            - name: empty-dir
              mountPath: /opt/bitnami/postgresql/logs
              subPath: app-logs-dir
            - name: dshm
              mountPath: /dev/shm
            - name: data
              mountPath: /bitnami/postgresql
      volumes:
        - name: empty-dir
          emptyDir: {}
        - name: dshm
          emptyDir:
            medium: Memory
  volumeClaimTemplates:
    - apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: data
      spec:
        accessModes:
          - "ReadWriteOnce"
        resources:
          requests:
            storage: "8Gi"

---
# Source: userservice/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: user-service-sa
  labels:
    helm.sh/chart: userservice-0.1.0
    app.kubernetes.io/name: userservice
    app.kubernetes.io/instance: userservice
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken:
---
# Source: userservice/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: userservice-config
data:
  "appsettings_override.json": |
    {
      "CorsOptions": {
        "AllowedOrigins": [
          "http://localhost:3000"
        ],
        "DefaultPolicyName": "DevelopmentCorsPolicy"
      },
      "ExternalUrls": {
        "MediaServiceApi": "https://media.my-prod-site.com"
      },
      "Frontend": {
        "EmailConfirmationPath": "/confirm-email",
        "EmailConfirmedPath": "/api/index.html?url=/api/specification.json",
        "PasswordResetPath": "/reset-password",
        "Url": "http://dev.amplify-vkr.example.com"
      },
      "InternalUrls": {
        "MediaServiceInternalBaseUrl": "http://media-service.default.svc.cluster.local"
      },
      "Jwt": {
        "Audience": "MyAppDevelopmentUsers",
        "Issuer": "http://userservice.test-env.svc.cluster.local/userservice/api/auth",
        "Key": "DevelopmentSecretKeyForJwtTokenGeneration",
        "PrivateKeyPem": "-----BEGIN PRIVATE KEY-----\nMIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCxHFHd6PSj473m\n6JvPKT4fwcIy0PMQsjs2VudEcVKeB5NoC9KOvy1wRF//FJIx/25qwb93lsAQPqCu\ngjc9GO6ZPoYIw5zwifHjJAuouQ3AS84ehDJPwr1uHYA2vUArKQ5yq5K0qENURucO\nyfLqRg+/SI9Mki7bc1kXLzzvAnvTE7JmwxAuxmRm89gScLoCQjeOYC5+xfmIukBP\nRNrOnHb/vMt59zfnl0ibBJK32J9O+XspTB8JvqkgGD+0CDFdZdQwtq92A3vtz5Cm\n7AKc638RhCk+MDkm3sLr+aDQBONnscgJfF9a+xSKTMcO/l+wkdyL2bdxd3xaReeH\nJdS4or3NAgMBAAECggEACyurmDD4uRuEnzs9lIfX5L3eR0E5i2yKYoeBp6X0HYaB\nzBauzZUOQx305gxAmkmvh6k3r83AyGWC0e7hmAdqCR1R69yWme9BY9+iop4lWWMO\nmYsh9zjjpL3Ul99A3FgHEsFyi9VvBbJBIYQoP5FyrdBgRWaU8P9p95XhpHuGHs5s\n0yI1pRhNro2tLpn+PfrlpeGN7eJcgn2sMaDWhLI1qD/1c1EO6WDbOOOx+jgiQQqL\nsvvxZpS6eadusMytAAY3sxwbJNWNUbK2sItWHObZSuOz6erxRCP8j3zy/HEY6QUJ\nrAlPtflLkD1wQS6KDHleT9FpnEW3vkL4wFmec/n8IQKBgQDheitrPIT69MgUjrrj\nCJnhnvh/b0LyGkFhfhMQPx8H2jqL3JjndEKwgycVzbcbfri4QI+43U/nOnigjNIy\nKWTXAuhiOLHOTOaDBn4ONIB8XVuItMl/FunRcinMPjPCnLB/VWrxyYRfncS9TUP4\nQhVaXot3/ce6F8IUqfqQ9M980QKBgQDJFgX93PwXfI2yN8zzT6yCG21FARA+KJHJ\ndm4DEn6+bFpZ609/hgSCL0ftk3LlgH7lb1amfU8jG6pwSVgiZk+ZWoiUlww96ruC\nKyhk7OUhYHTg+HS+RMUeWQx23yqBrg336D9l3vEFpsOGa5+CxjBIQhH90owtZ7kt\nm1ee9JIAPQKBgD/9MutJDphF9a5X31PlMf6k5fMMeVxJ9Toc1H4s27qXxTvCDCbL\niM2dOu9mJUwJR5UKxX76V93Qa0FtFY4kzzhx289cNaHNkzGmGwoe/kPNHtgKLpEB\nyLOnCZOsJ3ZYj4JjlGkv/oBAPwBWOC7xWiv+Xuhbvl3itjK1FqYiw+uxAoGACZKy\n1lMe7T9Qv5tIdozkeY00toRGca8cwaqRsjO/NPGTm5RIRJnsvQXjNrw+TA7B+8pB\nJcvxaIp4or/bIkgcogBdYDWQr6HtK1VCpwtgHSaqactqQ2Sivb8fiMk3DNVsdNDp\ns7/ZWZuG029sOJ2WztnWYW8UnVTCzBkJItgh20ECgYBHaZNUtjOaqOHjyVOqOyw7\nj4lXbox+fgnMkVelalpLv+bQXUd16hcU5ztg6+fo6VPiT1lObCZcNobZomXII2mU\nOJVnOuWcCWPAv1yYAsByPhG8nLmc1dS8yPj/Nxn+6agV0gcvQlWlSokWHcjJOyO7\nVRADnOB2UEfUN7Q7dDLWbA==\n-----END PRIVATE KEY-----"
      },
      "Logging": {
        "LogLevel": {
          "Default": "Information",
          "Microsoft": "Warning"
        }
      },
      "MailOptions": {
        "ApiKey": "API_KEY"
      },
      "MyCookies": {
        "AccessTokenCookieName": "MyAppAccessToken",
        "RefreshTokenCookieName": "MyAppRefreshToken"
      },
      "UserserviceOptions": {
        "BasePath": "/userservice"
      }
    }
---
# Source: userservice/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: userservice
  labels:
    helm.sh/chart: userservice-0.1.0
    app.kubernetes.io/name: userservice
    app.kubernetes.io/instance: userservice
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: userservice
    app.kubernetes.io/instance: userservice
---
# Source: userservice/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: userservice
  labels:
    helm.sh/chart: userservice-0.1.0
    app.kubernetes.io/name: userservice
    app.kubernetes.io/instance: userservice
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: userservice
      app.kubernetes.io/instance: userservice
  template:
    metadata:
      labels:
        helm.sh/chart: userservice-0.1.0
        app.kubernetes.io/name: userservice
        app.kubernetes.io/instance: userservice
        app.kubernetes.io/version: "1.16.0"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: user-service-sa
      containers:
        - name: userservice
          image: "ghcr.io/akisliy/amplify/userservice:latest"
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /userservice/health
              port: http
          readinessProbe:
            httpGet:
              path: /userservice/health
              port: http
          env:
            - name: ASPNETCORE_ENVIRONMENT
              value: "Development"
            - name: ASPNETCORE_HTTP_PORTS
              value: "80"
            - name: ConnectionStrings__UserServiceDb
              valueFrom:
                secretKeyRef:
                  name: userservice-k8s-secret
                  key: CONNECTION_STRING
          volumeMounts:
            - mountPath: /app/appsettings.Development.json
              name: config-volume
              subPath: appsettings_override.json
      volumes:
        - configMap:
            name: userservice-config
          name: config-volume
---
# Source: userservice/templates/secrets.yaml
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: userservice-secrets
spec:
  refreshInterval: 1h            
  secretStoreRef:
    kind: ClusterSecretStore
    name: gcp-store            
  target:
    name: userservice-k8s-secret
    creationPolicy: Owner
  data:
  - secretKey: CONNECTION_STRING 
    remoteRef:
      key: userservice-db-conn
---
# Source: userservice/templates/virtualservice.yaml
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: userservice-vs
spec:
  hosts:
  - "amplify.34.40.73.43.nip.io"
  # intenral service communication
  - "userservice.test-env.svc.cluster.local"
  gateways:
  - amplify-gateway
  http:
  - match:
    - uri:
        prefix: "/userservice"
    route:
    - destination:
        host: "userservice"
        port:
          number: 80
    timeout: 2s
    retries:
      attempts: 3
      perTryTimeout: 2s
      retryOn: gateway-error,connect-failure,refused-stream,5xx

---
# Source: publisher/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: publisher
  labels:
    helm.sh/chart: publisher-0.1.0
    app.kubernetes.io/name: publisher
    app.kubernetes.io/instance: publisher
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken:
---
# Source: publisher/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: publisher-config
data:
  "appsettings_override.json": |
    {
      "ExternalUrls": {
        "MediaServiceApi": "http://host.minikube.internal:6001"
      },
      "InstagramApiOptions": {
        "ApiVersion": "v22.0",
        "AppId": "instagram_app_id",
        "AppSecret": "instagram_app_secret",
        "BaseGraphHostUrl": "https://graph.facebook.com/",
        "DailyLimit": 200,
        "RedirectUri": "http://host.minikube.internal:6001/auth/instagram/callback"
      },
      "Jwt": {
        "Audience": "MyAppDevelopmentUsers",
        "Issuer": "http://userservice.default.svc.cluster.local/userservice/api/auth"
      },
      "Logging": {
        "LogLevel": {
          "Default": "Information",
          "Microsoft": "Warning",
          "Microsoft.Hosting.Lifetime": "Information"
        }
      },
      "MediaService": {
        "BaseUrl": "http://host.minikube.internal:6001"
      },
      "PublisherOptions": {
        "BasePath": "/publisher"
      },
      "RabbitMQOptions": {
        "Host": "host.minikube.internal",
        "Password": "guest",
        "Username": "guest"
      }
    }
---
# Source: publisher/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: publisher
  labels:
    helm.sh/chart: publisher-0.1.0
    app.kubernetes.io/name: publisher
    app.kubernetes.io/instance: publisher
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: publisher
    app.kubernetes.io/instance: publisher
---
# Source: publisher/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: publisher
  labels:
    helm.sh/chart: publisher-0.1.0
    app.kubernetes.io/name: publisher
    app.kubernetes.io/instance: publisher
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: publisher
      app.kubernetes.io/instance: publisher
  template:
    metadata:
      labels:
        helm.sh/chart: publisher-0.1.0
        app.kubernetes.io/name: publisher
        app.kubernetes.io/instance: publisher
        app.kubernetes.io/version: "1.16.0"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: publisher
      containers:
        - name: publisher
          image: "ghcr.io/akisliy/amplify/publisher:latest"
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /
              port: http
          readinessProbe:
            httpGet:
              path: /
              port: http
          env:
            - name: ASPNETCORE_ENVIRONMENT
              value: "Development"
            - name: ASPNETCORE_HTTP_PORTS
              value: "80"
          envFrom:
            - secretRef:
                name: publisher-k8s-secret
          volumeMounts:
            - mountPath: /app/appsettings.Development.json
              name: config-volume
              subPath: appsettings_override.json
      volumes:
        - configMap:
            name: publisher-config
          name: config-volume
---
# Source: publisher/templates/secrets.yaml
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: publisher-secrets
spec:
  refreshInterval: 1h          
  secretStoreRef:
    kind: ClusterSecretStore
    name: gcp-store            
  target:
    name: publisher-k8s-secret
    creationPolicy: Owner
  data:
  - secretKey: ConnectionStrings__Default
    remoteRef:
      key: publisher-db-conn-test
  - secretKey: ConnectionStrings__Hangfire
    remoteRef:
      key: publisher-hangfire-db-conn-test
  - secretKey: RabbitMQ__Url
    remoteRef:
      key: rabbitmq-test
---
# Source: publisher/templates/virtualservice.yaml
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: publisher-vs
spec:
  hosts:
  - "amplify.34.40.73.43.nip.io"
  # intenral service communication
  - "publisher.test-env.svc.cluster.local"
  gateways:
  - amplify-gateway
  http:
  - match:
    - uri:
        prefix: "/publisher"
    route:
    - destination:
        host: "publisher"
        port:
          number: 80
    timeout: 2s
    retries:
      attempts: 3
      perTryTimeout: 2s
      retryOn: gateway-error,connect-failure,refused-stream,5xx

---
# Source: mediaingest/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mediaingest-sa
  labels:
    helm.sh/chart: mediaingest-0.1.0
    app.kubernetes.io/name: mediaingest
    app.kubernetes.io/instance: mediaingest
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken:
---
# Source: mediaingest/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mediaingest-config
data:
  "appsettings_override.json": |
    {
      "DbConnection": {
        "Default": "Host=localhost;Port=54321;Database=usersDb;Username=root;Password=password"
      },
      "S3": {
        "AccessKey": "",
        "BucketName": "amplify-media-test",
        "Host": "storage.googleapis.com",
        "SecretKey": "",
        "UseSsl": true
      },
      "YtDlp": {
        "YoutubeDlPath": "/opt/homebrew/bin/yt-dlp"
      }
    }
---
# Source: mediaingest/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: mediaingest
  labels:
    helm.sh/chart: mediaingest-0.1.0
    app.kubernetes.io/name: mediaingest
    app.kubernetes.io/instance: mediaingest
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: mediaingest
    app.kubernetes.io/instance: mediaingest
---
# Source: mediaingest/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mediaingest
  labels:
    helm.sh/chart: mediaingest-0.1.0
    app.kubernetes.io/name: mediaingest
    app.kubernetes.io/instance: mediaingest
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: mediaingest
      app.kubernetes.io/instance: mediaingest
  template:
    metadata:
      labels:
        helm.sh/chart: mediaingest-0.1.0
        app.kubernetes.io/name: mediaingest
        app.kubernetes.io/instance: mediaingest
        app.kubernetes.io/version: "1.16.0"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: mediaingest-sa
      containers:
        - name: mediaingest
          image: "ghcr.io/akisliy/amplify/media-ingest:latest"
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /health
              port: http
          readinessProbe:
            httpGet:
              path: /health
              port: http
          env:
            - name: ASPNETCORE_ENVIRONMENT
              value: "Development"
            - name: ASPNETCORE_HTTP_PORTS
              value: "80"
          envFrom:
            - secretRef:
                name: mediaingest-k8s-secret
          volumeMounts:
            - mountPath: /app/appsettings.Development.json
              name: config-volume
              subpath: appsettings_override.json
      volumes:
        - configMap:
            name: mediaingest-config
          name: config-volume
---
# Source: mediaingest/templates/external-secrets.yaml
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: mediaingest-external-secrets
spec:
  refreshInterval: 1h            
  secretStoreRef:
    kind: ClusterSecretStore
    name: gcp-store            
  target:
    name: mediaingest-k8s-secret
    creationPolicy: Owner
  data:
  - secretKey: S3__AccessKey 
    remoteRef:
      key: test-bucket-access-key
  - secretKey: S3__SecretKey
    remoteRef:
      Key: test-bucket-secret-key
---
# Source: mediaingest/templates/virtualservice.yaml
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: mediaingest-vs
spec:
  hosts:
  - "amplify.34.40.73.43.nip.io"
  # intenral service communication
  - "mediaingest.test-env.svc.cluster.local"
  gateways:
  - amplify-gateway
  http:
  - match:
    - uri:
        prefix: "/media"
    route:
    - destination:
        host: "mediaingest"
        port:
          number: 80
    timeout: 2s
    retries:
      attempts: 3
      perTryTimeout: 2s
      retryOn: gateway-error,connect-failure,refused-stream,5xx

